<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crear Cotización</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1a202c; /* Dark background */
            color: #e2e8f0; /* Light text */
        }
        .card {
            background-color: #2d3748; /* Lighter card background */
            border-radius: 0.75rem; /* Rounded corners */
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        input[type="text"], input[type="number"], textarea, select {
            background-color: #4a5568; /* Dark input background */
            border: 1px solid #6b7280; /* Input border */
            color: #e2e8f0; /* Light input text */
            border-radius: 0.375rem; /* Small rounded corners */
            padding: 0.5rem 0.75rem;
        }
        input[type="text"]:focus, input[type="number"]:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #63b3ed; /* Blue border on focus */
            box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.5);
        }
        .btn-primary {
            background-color: #4299e1; /* Primary blue */
            color: white;
            padding: 0.75rem 1.25rem;
            border-radius: 0.5rem;
            transition: background-color 0.2s;
        }
        .btn-primary:hover {
            background-color: #3182ce; /* Darker blue on hover */
        }
        .btn-secondary {
            background-color: #6b7280; /* Secondary gray */
            color: white;
            padding: 0.75rem 1.25rem;
            border-radius: 0.5rem;
            transition: background-color 0.2s;
        }
        .btn-secondary:hover {
            background-color: #4a5568; /* Darker gray on hover */
        }
        .btn-danger {
            background-color: #e53e3e; /* Danger red */
            color: white;
            padding: 0.5rem 0.75rem;
            border-radius: 0.375rem;
            transition: background-color 0.2s;
        }
        .btn-danger:hover {
            background-color: #c53030; /* Darker red on hover */
        }
        .table-header {
            background-color: #4a5568;
            padding: 0.75rem 0;
            border-radius: 0.5rem;
            margin-bottom: 0.5rem;
        }
        /* Custom modal styles */
        .modal {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 1000; /* Sit on top */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if needed */
            background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: #2d3748;
            margin: auto;
            padding: 20px;
            border-radius: 0.75rem;
            width: 80%;
            max-width: 500px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            position: relative;
        }
        .close-button {
            color: #aaa;
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 28px;
            font-weight: bold;
        }
        .close-button:hover,
        .close-button:focus {
            color: #e2e8f0;
            text-decoration: none;
            cursor: pointer;
        }
    </style>
</head>
<body class="p-6">
    <div class="max-w-6xl mx-auto space-y-8">
        <!-- Título de la Cotización y Cliente -->
        <div class="card p-6">
            <h2 class="text-xl font-semibold mb-4">Información General</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label for="quotationTitle" class="block text-sm font-medium text-gray-300 mb-1">Título de la Cotización</label>
                    <input type="text" id="quotationTitle" class="w-full" placeholder="Ej. Cotización Proyecto X">
                </div>
                <div>
                    <label for="clientSelect" class="block text-sm font-medium text-gray-300 mb-1">Cliente</label>
                    <select id="clientSelect" class="w-full">
                        <option value="">Cargando clientes...</option>
                    </select>
                </div>
                <div id="clientDetails" class="md:col-span-2 text-sm text-gray-400 mt-2 hidden">
                    <p><strong>Dirección:</strong> <span id="clientAddress"></span></p>
                    <p><strong>ID Fiscal:</strong> <span id="clientTaxId"></span></p>
                </div>
            </div>
            <!-- La sección para añadir/eliminar clientes se ha eliminado, ya que se gestiona en tu backend -->
        </div>

        <!-- Detalles de Productos -->
        <div class="card p-6">
            <h2 class="text-xl font-semibold mb-4">Detalles de Productos</h2>
            <div class="flex flex-col sm:flex-row justify-between items-center mb-4 space-y-2 sm:space-y-0 sm:space-x-4">
                <button id="addRowBtn" class="btn-primary flex items-center justify-center w-full sm:w-auto">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
                    Agregar Fila
                </button>
                <button id="pasteExcelBtn" class="btn-secondary flex items-center justify-center w-full sm:w-auto">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 13h6m-3-3v6m-9 1V7a2 2 0 012-2h4l2 2h4a2 2 0 012 2v8a2 2 0 01-2 2H5a2 2 0 01-2-2z"></path></svg>
                    Pegar Datos de Excel
                </button>
            </div>

            <div class="hidden md:grid md:grid-cols-12 gap-4 text-sm font-medium text-gray-300 table-header">
                <div class="col-span-3 pl-2">Nombre del Producto</div>
                <div class="col-span-3">Descripción</div>
                <div class="col-span-1 text-center">Cantidad</div>
                <div class="col-span-2 text-center">Precio Unitario</div>
                <div class="col-span-1 text-center">Descuento (%)</div>
                <div class="col-span-1 text-center">Total</div>
                <div class="col-span-1"></div> <!-- For delete button -->
            </div>

            <div id="productRows" class="space-y-4">
                <!-- Product rows will be added here by JavaScript -->
            </div>
        </div>

        <!-- Resumen de la Cotización -->
        <div class="card p-6">
            <h2 class="text-xl font-semibold mb-4">Resumen de la Cotización</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="flex justify-between items-center">
                    <span class="text-gray-300">Subtotal:</span>
                    <span id="subtotal" class="font-bold text-lg">USD 0.00</span>
                </div>
                <div class="flex justify-between items-center">
                    <label for="taxRate" class="text-gray-300">IVA:</label>
                    <div class="flex items-center space-x-2">
                        <input type="number" id="taxRate" value="16" min="0" max="100" class="w-20 text-right">
                        <span class="text-gray-300">%</span>
                    </div>
                </div>
                <div class="flex justify-between items-center">
                    <span class="text-gray-300">Total IVA:</span>
                    <span id="totalTax" class="font-bold text-lg">USD 0.00</span>
                </div>
                <div class="flex justify-between items-center">
                    <label for="currencySelect" class="text-gray-300">Moneda:</label>
                    <select id="currencySelect" class="w-32">
                        <option value="USD">Dólares (USD)</option>
                        <option value="EUR">Euros (EUR)</option>
                        <option value="MXN">Pesos Mexicanos (MXN)</option>
                        <!-- Add more currencies as needed -->
                    </select>
                </div>
                <div class="flex justify-between items-center md:col-span-2 mt-4 pt-4 border-t border-gray-600">
                    <span class="text-gray-300 text-2xl font-semibold">Total:</span>
                    <span id="grandTotal" class="font-bold text-3xl text-blue-400">USD 0.00</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Custom Alert/Confirmation Modal -->
    <div id="customModal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <p id="modalMessage" class="text-white text-center text-lg mb-4"></p>
            <div id="modalButtons" class="flex justify-center space-x-4">
                <!-- Buttons will be added here by JavaScript -->
            </div>
        </div>
    </div>

    <script type="module">
        // DOM element references
        const productRowsContainer = document.getElementById('productRows');
        const addRowButton = document.getElementById('addRowBtn');
        const pasteExcelButton = document.getElementById('pasteExcelBtn');
        const subtotalSpan = document.getElementById('subtotal');
        const taxRateInput = document.getElementById('taxRate');
        const totalTaxSpan = document.getElementById('totalTax');
        const grandTotalSpan = document.getElementById('grandTotal');
        const currencySelect = document.getElementById('currencySelect');
        const clientSelect = document.getElementById('clientSelect');
        const clientDetailsDiv = document.getElementById('clientDetails');
        const clientAddressSpan = document.getElementById('clientAddress');
        const clientTaxIdSpan = document.getElementById('clientTaxId');

        // Custom Modal elements
        const customModal = document.getElementById('customModal');
        const modalMessage = document.getElementById('modalMessage');
        const modalButtons = document.getElementById('modalButtons');
        const closeModalButton = customModal.querySelector('.close-button');

        let rowCount = 0; // Counter for unique row IDs

        /**
         * Fetches clients from your Django backend API.
         * YOU MUST REPLACE 'YOUR_DJANGO_API_URL/clients-for-user/' WITH THE ACTUAL URL
         * OF YOUR DJANGO API ENDPOINT THAT RETURNS THE LIST OF CLIENTS ASSIGNED TO THE CURRENT USER.
         *
         * THE DJANGO API SHOULD RETURN AN ARRAY OF CLIENT OBJECTS, E.G.:
         * [{ ID: '1', NAME: 'CLIENTE A', ADDRESS: 'DIR A', TAXID: 'TAXA' }, ...]
         * MAKE SURE THE 'ID' FIELD MATCHES THE PRIMARY KEY OF YOUR CLIENT MODEL.
         */
        async function fetchClientsFromAPI() {
            try {
                // IMPORTANT: REPLACE THIS URL WITH THE ACTUAL URL OF YOUR DJANGO API ENDPOINT.
                // EXAMPLE: 'http://127.0.0.1:8000/api/clients-for-user/' IF RUNNING LOCALLY
                // OR 'https://your-production-domain.com/api/clients-for-user/'
                const response = await fetch('http://127.0.0.1:8000/api/clients-for-user/'); // <-- ¡IMPORTANTE! Reemplaza esta URL

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const clients = await response.json();
                console.log("Clientes obtenidos de la API de Django:", clients);
                return clients;
            } catch (error) {
                console.error("Error fetching clients from Django API:", error);
                showCustomModal("Error al cargar la lista de clientes. Por favor, asegúrese de que su backend de Django esté funcionando, la URL de la API sea correcta y CORS esté configurado si es necesario.", false);
                return []; // Return empty array on error
            }
        }

        /**
         * Loads clients from the API and updates the UI.
         */
        async function loadClients() {
            clientSelect.innerHTML = '<option value="">Cargando clientes...</option>';
            const clients = await fetchClientsFromAPI();
            populateClientDropdown(clients);
            updateClientDetails(); // Update details in case selected client was modified/deleted
        }

        /**
         * Populates the client dropdown select element.
         * @param {Array} clients - Array of client objects from your API.
         */
        function populateClientDropdown(clients) {
            clientSelect.innerHTML = '<option value="">Seleccione un cliente</option>'; // Clear existing options
            if (clients.length === 0) {
                clientSelect.innerHTML = '<option value="">No hay clientes asignados.</option>';
            }

            clients.forEach(client => {
                const option = document.createElement('option');
                option.value = client.id;
                option.textContent = client.name;
                // Store address and tax ID in data attributes for easy access
                option.dataset.address = client.address || ''; // Use empty string if not available
                option.dataset.taxId = client.taxId || ''; // Use empty string if not available
                clientSelect.appendChild(option);
            });

            // Re-select the previously selected client if it still exists
            const currentSelectedId = clientSelect.dataset.selectedClientId;
            if (currentSelectedId && clients.some(c => c.id == currentSelectedId)) { // Use == for potential type coercion (string vs number ID)
                clientSelect.value = currentSelectedId;
            } else {
                clientSelect.value = ''; // Clear selection if client no longer exists
            }
            updateClientDetails(); // Ensure details are updated based on current selection
        }

        /**
         * Creates a new product row in the table.
         * @param {Object} [data={}] - Initial data for the row (product, description, quantity, price, discount).
         */
        function createProductRow(data = {}) {
            const id = rowCount++; // Generate a unique ID for the row
            const row = document.createElement('div');
            row.id = `row-${id}`;
            row.classList.add('grid', 'grid-cols-1', 'md:grid-cols-12', 'gap-4', 'items-center', 'p-4', 'card');

            row.innerHTML = `
                <div class="col-span-12 md:col-span-3">
                    <label for="productName-${id}" class="block md:hidden text-sm font-medium text-gray-300 mb-1">Nombre del Producto</label>
                    <input type="text" id="productName-${id}" class="w-full product-name" placeholder="Nombre del producto" value="${data.name || ''}">
                </div>
                <div class="col-span-12 md:col-span-3">
                    <label for="productDescription-${id}" class="block md:hidden text-sm font-medium text-gray-300 mb-1">Descripción</label>
                    <textarea id="productDescription-${id}" class="w-full h-20 md:h-auto resize-y" placeholder="Descripción detallada del producto">${data.description || ''}</textarea>
                </div>
                <div class="col-span-4 md:col-span-1">
                    <label for="productQuantity-${id}" class="block md:hidden text-sm font-medium text-gray-300 mb-1">Cantidad</label>
                    <input type="number" id="productQuantity-${id}" class="w-full text-right product-quantity" value="${data.quantity || 1}" min="1">
                </div>
                <div class="col-span-8 md:col-span-2">
                    <label for="productPrice-${id}" class="block md:hidden text-sm font-medium text-gray-300 mb-1">Precio Unitario</label>
                    <input type="number" id="productPrice-${id}" class="w-full text-right product-price" value="${data.price || 0.00}" min="0" step="0.01">
                </div>
                <div class="col-span-6 md:col-span-1">
                    <label for="productDiscount-${id}" class="block md:hidden text-sm font-medium text-gray-300 mb-1">Descuento (%)</label>
                    <input type="number" id="productDiscount-${id}" class="w-full text-right product-discount" value="${data.discount || 0}" min="0" max="100">
                </div>
                <div class="col-span-6 md:col-span-1 flex items-center justify-end md:justify-center">
                    <span id="productTotal-${id}" class="font-bold text-lg product-total">USD 0.00</span>
                </div>
                <div class="col-span-12 md:col-span-1 flex justify-end md:justify-center">
                    <button class="btn-danger remove-row-btn">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                    </button>
                </div>
            `;

            productRowsContainer.appendChild(row);

            // Add event listeners to the inputs of the new row
            const quantityInput = row.querySelector(`#productQuantity-${id}`);
            const priceInput = row.querySelector(`#productPrice-${id}`);
            const discountInput = row.querySelector(`#productDiscount-${id}`);
            const removeButton = row.querySelector('.remove-row-btn');

            quantityInput.addEventListener('input', calculateRowTotal);
            priceInput.addEventListener('input', calculateRowTotal);
            discountInput.addEventListener('input', calculateRowTotal);
            removeButton.addEventListener('click', () => removeProductRow(row));

            calculateRowTotal({ target: quantityInput }); // Calculate initial row total
        }

        /**
         * Calculates the total for a product row and updates general totals.
         * @param {Event} event - The event that triggered the function (e.g., 'input').
         */
        function calculateRowTotal(event) {
            const row = event.target.closest('.grid'); // Find the parent row
            if (!row) return;

            const quantity = parseFloat(row.querySelector('.product-quantity').value) || 0;
            const price = parseFloat(row.querySelector('.product-price').value) || 0;
            const discountPercent = parseFloat(row.querySelector('.product-discount').value) || 0;
            const productTotalSpan = row.querySelector('.product-total');

            let total = quantity * price;
            if (discountPercent > 0) {
                total -= total * (discountPercent / 100);
            }

            productTotalSpan.textContent = formatCurrency(total);
            calculateGrandTotal(); // Recalculate general totals every time a row changes
        }

        /**
         * Removes a product row from the DOM.
         * @param {HTMLElement} rowElement - The row element to remove.
         */
        function removeProductRow(rowElement) {
            rowElement.remove();
            calculateGrandTotal(); // Recalculate general totals after removing a row
        }

        /**
         * Calculates the subtotal, tax, and grand total of the quotation.
         */
        function calculateGrandTotal() {
            let subtotal = 0;
            document.querySelectorAll('.product-total').forEach(span => {
                // Remove currency symbol and convert to number
                subtotal += parseFloat(span.textContent.replace(/[^0-9.-]+/g, "")) || 0;
            });

            const taxRate = parseFloat(taxRateInput.value) || 0;
            const totalTax = subtotal * (taxRate / 100);
            const grandTotal = subtotal + totalTax;

            subtotalSpan.textContent = formatCurrency(subtotal);
            totalTaxSpan.textContent = formatCurrency(totalTax);
            grandTotalSpan.textContent = formatCurrency(grandTotal);
        }

        /**
         * Formats a number as currency.
         * @param {number} amount - The amount to format.
         * @returns {string} The formatted amount as a currency string.
         */
        function formatCurrency(amount) {
            const currency = currencySelect.value;
            return new Intl.NumberFormat('es-ES', {
                style: 'currency',
                currency: currency
            }).format(amount);
        }

        /**
         * Updates the selected client's details.
         */
        function updateClientDetails() {
            const selectedClientId = clientSelect.value;
            // Store the selected ID to re-select after client list updates
            clientSelect.dataset.selectedClientId = selectedClientId;

            if (!selectedClientId) {
                clientAddressSpan.textContent = '';
                clientTaxIdSpan.textContent = '';
                clientDetailsDiv.classList.add('hidden');
                return;
            }

            // Find the client in the current options
            const selectedOption = clientSelect.options[clientSelect.selectedIndex];
            if (selectedOption && selectedOption.dataset.address && selectedOption.dataset.taxId) {
                clientAddressSpan.textContent = selectedOption.dataset.address;
                clientTaxIdSpan.textContent = selectedOption.dataset.taxId;
                clientDetailsDiv.classList.remove('hidden');
            } else {
                clientAddressSpan.textContent = '';
                clientTaxIdSpan.textContent = '';
                clientDetailsDiv.classList.add('hidden');
            }
        }

        /**
         * Handles pasting data from Excel.
         * Assumes data is in the order: Name, Description, Quantity, Unit Price, Discount.
         */
        async function handlePasteExcel() {
            try {
                const text = await navigator.clipboard.readText();
                const lines = text.split('\n').filter(line => line.trim() !== ''); // Filter empty lines

                if (lines.length === 0) {
                    showCustomModal("No se encontraron datos válidos en el portapapeles.", false);
                    return;
                }

                // Clear existing rows before pasting
                productRowsContainer.innerHTML = '';
                rowCount = 0; // Reset row counter

                lines.forEach(line => {
                    const columns = line.split('\t'); // Excel data is usually tab-separated
                    if (columns.length >= 5) { // Ensure there are enough columns
                        const data = {
                            name: columns[0],
                            description: columns[1],
                            quantity: parseFloat(columns[2]) || 1,
                            price: parseFloat(columns[3]) || 0,
                            discount: parseFloat(columns[4]) || 0
                        };
                        createProductRow(data);
                    } else {
                        console.warn("Excel row with unexpected format, skipping:", line);
                    }
                });
                calculateGrandTotal(); // Recalculate after pasting all data
            } catch (err) {
                console.error('Error reading from clipboard:', err);
                showCustomModal('No se pudo leer del portapapeles. Asegúrate de haber copiado datos de una tabla (ej. Excel).', false);
            }
        }

        // --- Custom Modal Functions (replaces alert/confirm) ---
        function showCustomModal(message, isConfirm = false, onConfirm = null) {
            modalMessage.textContent = message;
            modalButtons.innerHTML = ''; // Clear previous buttons

            if (isConfirm) {
                const confirmBtn = document.createElement('button');
                confirmBtn.textContent = 'Confirmar';
                confirmBtn.classList.add('btn-primary', 'px-4', 'py-2');
                confirmBtn.onclick = () => {
                    if (onConfirm) onConfirm();
                    customModal.style.display = 'none';
                };
                modalButtons.appendChild(confirmBtn);

                const cancelBtn = document.createElement('button');
                cancelBtn.textContent = 'Cancelar';
                cancelBtn.classList.add('btn-secondary', 'px-4', 'py-2');
                cancelBtn.onclick = () => {
                    customModal.style.display = 'none';
                };
                modalButtons.appendChild(cancelBtn);
            } else {
                const okBtn = document.createElement('button');
                okBtn.textContent = 'OK';
                okBtn.classList.add('btn-primary', 'px-4', 'py-2');
                okBtn.onclick = () => {
                    customModal.style.display = 'none';
                };
                modalButtons.appendChild(okBtn);
            }
            customModal.style.display = 'flex'; // Show the modal
        }

        // Close modal when clicking on 'x'
        closeModalButton.addEventListener('click', () => {
            customModal.style.display = 'none';
        });

        // Close modal when clicking outside of the modal content
        window.addEventListener('click', (event) => {
            if (event.target == customModal) {
                customModal.style.display = 'none';
            }
        });


        // --- Event Listeners ---
        addRowButton.addEventListener('click', () => createProductRow());
        taxRateInput.addEventListener('input', calculateGrandTotal);
        currencySelect.addEventListener('change', calculateGrandTotal);
        clientSelect.addEventListener('change', updateClientDetails);
        pasteExcelButton.addEventListener('click', handlePasteExcel);


        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            loadClients(); // Load clients from your Django backend API
            createProductRow(); // Add an initial row by default
            calculateGrandTotal(); // Calculate initial totals
        });
    </script>
</body>
</html>

{% extends 'base.html' %}
{% block content %}
    <!DOCTYPE html>
    <html lang="es">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Crear Cotización</title>
        <!-- Tailwind CSS CDN -->
        <script src="https://cdn.tailwindcss.com"></script>
        <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
        <style>
            body {
                font-family: 'Inter', sans-serif;
                background-color: #1a202c; /* Dark background */
                color: #e2e8f0; /* Light text */
            }
            .card {
                background-color: #2d3748; /* Lighter card background */
                border-radius: 0.75rem; /* Rounded corners */
                box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            }
            input[type="text"], input[type="number"], textarea, select {
                background-color: #4a5568; /* Dark input background */
                border: 1px solid #6b7280; /* Input border */
                color: #e2e8f0; /* Light input text */
                border-radius: 0.375rem; /* Small rounded corners */
                padding: 0.5rem 0.75rem;
            }
            input[type="text"]:focus, input[type="number"]:focus, textarea:focus, select:focus {
                outline: none;
                border-color: #63b3ed; /* Blue border on focus */
                box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.5);
            }
            .btn-primary {
                background-color: #4299e1; /* Primary blue */
                color: white;
                padding: 0.75rem 1.25rem;
                border-radius: 0.5rem;
                transition: background-color 0.2s;
            }
            .btn-primary:hover {
                background-color: #3182ce; /* Darker blue on hover */
            }
            .btn-secondary {
                background-color: #6b7280; /* Secondary gray */
                color: white;
                padding: 0.75rem 1.25rem;
                border-radius: 0.5rem;
                transition: background-color 0.2s;
            }
            .btn-secondary:hover {
                background-color: #4a5568; /* Darker gray on hover */
            }
            .btn-danger {
                background-color: #e53e3e; /* Danger red */
                color: white;
                padding: 0.5rem 0.75rem;
                border-radius: 0.375rem;
                transition: background-color 0.2s;
            }
            .btn-danger:hover {
                background-color: #c53030; /* Darker red on hover */
            }
            .table-header {
                background-color: #4a5568;
                padding: 0.75rem 0;
                border-radius: 0.5rem;
                margin-bottom: 0.5rem;
            }
            /* Custom modal styles */
            .modal {
                display: none; /* Hidden by default */
                position: fixed; /* Stay in place */
                z-index: 1000; /* Sit on top */
                left: 0;
                top: 0;
                width: 100%; /* Full width */
                height: 100%; /* Full height */
                overflow: auto; /* Enable scroll if needed */
                background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
                justify-content: center;
                align-items: center;
            }
            .modal-content {
                background-color: #2d3748;
                margin: auto;
                padding: 20px;
                border-radius: 0.75rem;
                width: 80%;
                max-width: 500px;
                box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
                position: relative;
            }
            .close-button {
                color: #aaa;
                position: absolute;
                top: 10px;
                right: 15px;
                font-size: 28px;
                font-weight: bold;
            }
            .close-button:hover,
            .close-button:focus {
                color: #e2e8f0;
                text-decoration: none;
                cursor: pointer;
            }
        </style>
    </head>
    <body class="p-6">
        <div class="max-w-6xl mx-auto space-y-8">
            <!-- Título de la Cotización y Cliente -->
            <div class="card p-6">
                <h2 class="text-xl font-semibold mb-4">Información General</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="quotationTitle" class="block text-sm font-medium text-gray-300 mb-1">Título de la Cotización</label>
                        <input type="text" id="quotationTitle" class="w-full" placeholder="Ej. Cotización Proyecto X">
                    </div>
                    <div>
                        <label for="clientSelect" class="block text-sm font-medium text-gray-300 mb-1">Cliente</label>
                        <select id="clientSelect" class="w-full">
                            <option value="">Cargando clientes...</option>
                        </select>
                    </div>
                    <div id="clientDetails" class="md:col-span-2 text-sm text-gray-400 mt-2 hidden">
                        <p><strong>Dirección:</strong> <span id="clientAddress"></span></p>
                        <p><strong>ID Fiscal:</strong> <span id="clientTaxId"></span></p>
                    </div>
                </div>
                <!-- La sección para añadir/eliminar clientes se ha eliminado, ya que se gestiona en tu backend -->
            </div>

            <!-- Detalles de Productos -->
            <div class="card p-6">
                <h2 class="text-xl font-semibold mb-4">Detalles de Productos</h2>
                <div class="flex flex-col sm:flex-row justify-between items-center mb-4 space-y-2 sm:space-y-0 sm:space-x-4">
                    <button id="addRowBtn" class="btn-primary flex items-center justify-center w-full sm:w-auto">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
                        Agregar Fila
                    </button>
                    <button id="pasteExcelBtn" class="btn-secondary flex items-center justify-center w-full sm:w-auto">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 13h6m-3-3v6m-9 1V7a2 2 0 012-2h4l2 2h4a2 2 0 012 2v8a2 2 0 01-2 2H5a2 2 0 01-2-2z"></path></svg>
                        Pegar Datos de Excel
                    </button>
                </div>

                <div class="hidden md:grid md:grid-cols-12 gap-4 text-sm font-medium text-gray-300 table-header">
                    <div class="col-span-3 pl-2">Nombre del Producto</div>
                    <div class="col-span-3">Descripción</div>
                    <div class="col-span-1 text-center">Cantidad</div>
                    <div class="col-span-2 text-center">Precio Unitario</div>
                    <div class="col-span-1 text-center">Descuento (%)</div>
                    <div class="col-span-1 text-center">Total</div>
                    <div class="col-span-1"></div> <!-- For delete button -->
                </div>

                <div id="productRows" class="space-y-4">
                    <!-- Product rows will be added here by JavaScript -->
                </div>
            </div>

            <!-- Resumen de la Cotización -->
            <div class="card p-6">
                <h2 class="text-xl font-semibold mb-4">Resumen de la Cotización</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="flex justify-between items-center">
                        <span class="text-gray-300">Subtotal:</span>
                        <span id="subtotal" class="font-bold text-lg">USD 0.00</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <label for="taxRate" class="text-gray-300">IVA:</label>
                        <div class="flex items-center space-x-2">
                            <input type="number" id="taxRate" value="16" min="0" max="100" class="w-20 text-right">
                            <span class="text-gray-300">%</span>
                        </div>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-gray-300">Total IVA:</span>
                        <span id="totalTax" class="font-bold text-lg">USD 0.00</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <label for="currencySelect" class="text-gray-300">Moneda:</label>
                        <select id="currencySelect" class="w-32">
                            <option value="USD">Dólares (USD)</option>
                            <option value="EUR">Euros (EUR)</option>
                            <option value="MXN">Pesos Mexicanos (MXN)</option>
                            <!-- Add more currencies as needed -->
                        </select>
                    </div>
                    <div class="flex justify-between items-center md:col-span-2 mt-4 pt-4 border-t border-gray-600">
                        <span class="text-gray-300 text-2xl font-semibold">Total:</span>
                        <span id="grandTotal" class="font-bold text-3xl text-blue-400">USD 0.00</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Custom Alert/Confirmation Modal -->
        <div id="customModal" class="modal">
            <div class="modal-content">
                <span class="close-button">&times;</span>
                <p id="modalMessage" class="text-white text-center text-lg mb-4"></p>
                <div id="modalButtons" class="flex justify-center space-x-4">
                    <!-- Buttons will be added here by JavaScript -->
                </div>
            </div>
        </div>

        <script type="module">
            // DOM element references
            const productRowsContainer = document.getElementById('productRows');
            const addRowButton = document.getElementById('addRowBtn');
            const pasteExcelButton = document.getElementById('pasteExcelBtn');
            const subtotalSpan = document.getElementById('subtotal');
            const taxRateInput = document.getElementById('taxRate');
            const totalTaxSpan = document.getElementById('totalTax');
            const grandTotalSpan = document.getElementById('grandTotal');
            const currencySelect = document.getElementById('currencySelect');
            const clientSelect = document.getElementById('clientSelect');
            const clientDetailsDiv = document.getElementById('clientDetails');
            const clientAddressSpan = document.getElementById('clientAddress');
            const clientTaxIdSpan = document.getElementById('clientTaxId');

            // Custom Modal elements
            const customModal = document.getElementById('customModal');
            const modalMessage = document.getElementById('modalMessage');
            const modalButtons = document.getElementById('modalButtons');
            const closeModalButton = customModal.querySelector('.close-button');

            let rowCount = 0; // Counter for unique row IDs

            /**
             * Fetches clients from your Django backend API.
             * YOU MUST REPLACE 'YOUR_DJANGO_API_URL/clients-for-user/' WITH THE ACTUAL URL
             * OF YOUR DJANGO API ENDPOINT THAT RETURNS THE LIST OF CLIENTS ASSIGNED TO THE CURRENT USER.
             *
             * THE DJANGO API SHOULD RETURN AN ARRAY OF CLIENT OBJECTS, E.G.:
             * [{ ID: '1', NAME: 'CLIENTE A', ADDRESS: 'DIR A', TAXID: 'TAXA' }, ...]
             * MAKE SURE THE 'ID' FIELD MATCHES THE PRIMARY KEY OF YOUR CLIENT MODEL.
             */
            async function fetchClientsFromAPI() {
                try {
                    // IMPORTANT: REPLACE THIS URL WITH THE ACTUAL URL OF YOUR DJANGO API ENDPOINT.
                    // EXAMPLE: 'http://127.0.0.1:8000/api/clients-for-user/' IF RUNNING LOCALLY
                    // OR 'https://your-production-domain.com/api/clients-for-user/'
                    const response = await fetch('http://127.0.0.1:8000/api/clients-for-user/'); // <-- ¡IMPORTANTE! Reemplaza esta URL

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    const clients = await response.json();
                    console.log("Clientes obtenidos de la API de Django:", clients);
                    return clients;
                } catch (error) {
                    console.error("Error fetching clients from Django API:", error);
                    showCustomModal("Error al cargar la lista de clientes. Por favor, asegúrese de que su backend de Django esté funcionando, la URL de la API sea correcta y CORS esté configurado si es necesario.", false);
                    return []; // Return empty array on error
                }
            }

            /**
             * Loads clients from the API and updates the UI.
             */
            async function loadClients() {
                clientSelect.innerHTML = '<option value="">Cargando clientes...</option>';
                const clients = await fetchClientsFromAPI();
                populateClientDropdown(clients);
                updateClientDetails(); // Update details in case selected client was modified/deleted
            }

            /**
             * Populates the client dropdown select element.
             * @param {Array} clients - Array of client objects from your API.
             */
            function populateClientDropdown(clients) {
                clientSelect.innerHTML = '<option value="">Seleccione un cliente</option>'; // Clear existing options
                if (clients.length === 0) {
                    clientSelect.innerHTML = '<option value="">No hay clientes asignados.</option>';
                }

                clients.forEach(client => {
                    const option = document.createElement('option');
                    option.value = client.id;
                    option.textContent = client.name;
                    // Store address and tax ID in data attributes for easy access
                    option.dataset.address = client.address || ''; // Use empty string if not available
                    option.dataset.taxId = client.taxId || ''; // Use empty string if not available
                    clientSelect.appendChild(option);
                });

                // Re-select the previously selected client if it still exists
                const currentSelectedId = clientSelect.dataset.selectedClientId;
                if (currentSelectedId && clients.some(c => c.id == currentSelectedId)) { // Use == for potential type coercion (string vs number ID)
                    clientSelect.value = currentSelectedId;
                } else {
                    clientSelect.value = ''; // Clear selection if client no longer exists
                }
                updateClientDetails(); // Ensure details are updated based on current selection
            }

            /**
             * Creates a new product row in the table.
             * @param {Object} [data={}] - Initial data for the row (product, description, quantity, price, discount).
             */
            function createProductRow(data = {}) {
                const id = rowCount++; // Generate a unique ID for the row
                const row = document.createElement('div');
                row.id = `row-${id}`;
                row.classList.add('grid', 'grid-cols-1', 'md:grid-cols-12', 'gap-4', 'items-center', 'p-4', 'card');

                row.innerHTML = `
                    <div class="col-span-12 md:col-span-3">
                        <label for="productName-${id}" class="block md:hidden text-sm font-medium text-gray-300 mb-1">Nombre del Producto</label>
                        <input type="text" id="productName-${id}" class="w-full product-name" placeholder="Nombre del producto" value="${data.name || ''}">
                    </div>
                    <div class="col-span-12 md:col-span-3">
                        <label for="productDescription-${id}" class="block md:hidden text-sm font-medium text-gray-300 mb-1">Descripción</label>
                        <textarea id="productDescription-${id}" class="w-full h-20 md:h-auto resize-y" placeholder="Descripción detallada del producto">${data.description || ''}</textarea>
                    </div>
                    <div class="col-span-4 md:col-span-1">
                        <label for="productQuantity-${id}" class="block md:hidden text-sm font-medium text-gray-300 mb-1">Cantidad</label>
                        <input type="number" id="productQuantity-${id}" class="w-full text-right product-quantity" value="${data.quantity || 1}" min="1">
                    </div>
                    <div class="col-span-8 md:col-span-2">
                        <label for="productPrice-${id}" class="block md:hidden text-sm font-medium text-gray-300 mb-1">Precio Unitario</label>
                        <input type="number" id="productPrice-${id}" class="w-full text-right product-price" value="${data.price || 0.00}" min="0" step="0.01">
                    </div>
                    <div class="col-span-6 md:col-span-1">
                        <label for="productDiscount-${id}" class="block md:hidden text-sm font-medium text-gray-300 mb-1">Descuento (%)</label>
                        <input type="number" id="productDiscount-${id}" class="w-full text-right product-discount" value="${data.discount || 0}" min="0" max="100">
                    </div>
                    <div class="col-span-6 md:col-span-1 flex items-center justify-end md:justify-center">
                        <span id="productTotal-${id}" class="font-bold text-lg product-total">USD 0.00</span>
                    </div>
                    <div class="col-span-12 md:col-span-1 flex justify-end md:justify-center">
                        <button class="btn-danger remove-row-btn">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                        </button>
                    </div>
                `;

                productRowsContainer.appendChild(row);

                // Add event listeners to the inputs of the new row
                const quantityInput = row.querySelector(`#productQuantity-${id}`);
                const priceInput = row.querySelector(`#productPrice-${id}`);
                const discountInput = row.querySelector(`#productDiscount-${id}`);
                const removeButton = row.querySelector('.remove-row-btn');

                quantityInput.addEventListener('input', calculateRowTotal);
                priceInput.addEventListener('input', calculateRowTotal);
                discountInput.addEventListener('input', calculateRowTotal);
                removeButton.addEventListener('click', () => removeProductRow(row));

                calculateRowTotal({ target: quantityInput }); // Calculate initial row total
            }

            /**
             * Calculates the total for a product row and updates general totals.
             * @param {Event} event - The event that triggered the function (e.g., 'input').
             */
            function calculateRowTotal(event) {
                const row = event.target.closest('.grid'); // Find the parent row
                if (!row) return;

                const quantity = parseFloat(row.querySelector('.product-quantity').value) || 0;
                const price = parseFloat(row.querySelector('.product-price').value) || 0;
                const discountPercent = parseFloat(row.querySelector('.product-discount').value) || 0;
                const productTotalSpan = row.querySelector('.product-total');

                let total = quantity * price;
                if (discountPercent > 0) {
                    total -= total * (discountPercent / 100);
                }

                productTotalSpan.textContent = formatCurrency(total);
                calculateGrandTotal(); // Recalculate general totals every time a row changes
            }

            /**
             * Removes a product row from the DOM.
             * @param {HTMLElement} rowElement - The row element to remove.
             */
            function removeProductRow(rowElement) {
                rowElement.remove();
                calculateGrandTotal(); // Recalculate general totals after removing a row
            }

            /**
             * Calculates the subtotal, tax, and grand total of the quotation.
             */
            function calculateGrandTotal() {
                let subtotal = 0;
                document.querySelectorAll('.product-total').forEach(span => {
                    // Remove currency symbol and convert to number
                    subtotal += parseFloat(span.textContent.replace(/[^0-9.-]+/g, "")) || 0;
                });

                const taxRate = parseFloat(taxRateInput.value) || 0;
                const totalTax = subtotal * (taxRate / 100);
                const grandTotal = subtotal + totalTax;

                subtotalSpan.textContent = formatCurrency(subtotal);
                totalTaxSpan.textContent = formatCurrency(totalTax);
                grandTotalSpan.textContent = formatCurrency(grandTotal);
            }

            /**
             * Formats a number as currency.
             * @param {number} amount - The amount to format.
             * @returns {string} The formatted amount as a currency string.
             */
            function formatCurrency(amount) {
                const currency = currencySelect.value;
                return new Intl.NumberFormat('es-ES', {
                    style: 'currency',
                    currency: currency
                }).format(amount);
            }

            /**
             * Updates the selected client's details.
             */
            function updateClientDetails() {
                const selectedClientId = clientSelect.value;
                // Store the selected ID to re-select after client list updates
                clientSelect.dataset.selectedClientId = selectedClientId;

                if (!selectedClientId) {
                    clientAddressSpan.textContent = '';
                    clientTaxIdSpan.textContent = '';
                    clientDetailsDiv.classList.add('hidden');
                    return;
                }

                // Find the client in the current options
                const selectedOption = clientSelect.options[clientSelect.selectedIndex];
                if (selectedOption && selectedOption.dataset.address && selectedOption.dataset.taxId) {
                    clientAddressSpan.textContent = selectedOption.dataset.address;
                    clientTaxIdSpan.textContent = selectedOption.dataset.taxId;
                    clientDetailsDiv.classList.remove('hidden');
                } else {
                    clientAddressSpan.textContent = '';
                    clientTaxIdSpan.textContent = '';
                    clientDetailsDiv.classList.add('hidden');
                }
            }

            /**
             * Handles pasting data from Excel.
             * Assumes data is in the order: Name, Description, Quantity, Unit Price, Discount.
             */
            async function handlePasteExcel() {
                try {
                    const text = await navigator.clipboard.readText();
                    const lines = text.split('\n').filter(line => line.trim() !== ''); // Filter empty lines

                    if (lines.length === 0) {
                        showCustomModal("No se encontraron datos válidos en el portapapeles.", false);
                        return;
                    }

                    // Clear existing rows before pasting
                    productRowsContainer.innerHTML = '';
                    rowCount = 0; // Reset row counter

                    lines.forEach(line => {
                        const columns = line.split('\t'); // Excel data is usually tab-separated
                        if (columns.length >= 5) { // Ensure there are enough columns
                            const data = {
                                name: columns[0],
                                description: columns[1],
                                quantity: parseFloat(columns[2]) || 1,
                                price: parseFloat(columns[3]) || 0,
                                discount: parseFloat(columns[4]) || 0
                            };
                            createProductRow(data);
                        } else {
                            console.warn("Excel row with unexpected format, skipping:", line);
                        }
                    });
                    calculateGrandTotal(); // Recalculate after pasting all data
                } catch (err) {
                    console.error('Error reading from clipboard:', err);
                    showCustomModal('No se pudo leer del portapapeles. Asegúrate de haber copiado datos de una tabla (ej. Excel).', false);
                }
            }

            // --- Custom Modal Functions (replaces alert/confirm) ---
            function showCustomModal(message, isConfirm = false, onConfirm = null) {
                modalMessage.textContent = message;
                modalButtons.innerHTML = ''; // Clear previous buttons

                if (isConfirm) {
                    const confirmBtn = document.createElement('button');
                    confirmBtn.textContent = 'Confirmar';
                    confirmBtn.classList.add('btn-primary', 'px-4', 'py-2');
                    confirmBtn.onclick = () => {
                        if (onConfirm) onConfirm();
                        customModal.style.display = 'none';
                    };
                    modalButtons.appendChild(confirmBtn);

                    const cancelBtn = document.createElement('button');
                    cancelBtn.textContent = 'Cancelar';
                    cancelBtn.classList.add('btn-secondary', 'px-4', 'py-2');
                    cancelBtn.onclick = () => {
                        customModal.style.display = 'none';
                    };
                    modalButtons.appendChild(cancelBtn);
                } else {
                    const okBtn = document.createElement('button');
                    okBtn.textContent = 'OK';
                    okBtn.classList.add('btn-primary', 'px-4', 'py-2');
                    okBtn.onclick = () => {
                        customModal.style.display = 'none';
                    };
                    modalButtons.appendChild(okBtn);
                }
                customModal.style.display = 'flex'; // Show the modal
            }

            // Close modal when clicking on 'x'
            closeModalButton.addEventListener('click', () => {
                customModal.style.display = 'none';
            });

            // Close modal when clicking outside of the modal content
            window.addEventListener('click', (event) => {
                if (event.target == customModal) {
                    customModal.style.display = 'none';
                }
            });


            // --- Event Listeners ---
            addRowButton.addEventListener('click', () => createProductRow());
            taxRateInput.addEventListener('input', calculateGrandTotal);
            currencySelect.addEventListener('change', calculateGrandTotal);
            clientSelect.addEventListener('change', updateClientDetails);
            pasteExcelButton.addEventListener('click', handlePasteExcel);


            // --- Initialization ---
            document.addEventListener('DOMContentLoaded', () => {
                loadClients(); // Load clients from your Django backend API
                createProductRow(); // Add an initial row by default
                calculateGrandTotal(); // Calculate initial totals
            });
        </script>
    </body>
    </html>
{% endblock %}
{% set hide_dock = True %}